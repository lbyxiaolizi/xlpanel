<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OpenHost</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: calc(100vh - 56px);
            background: #212529;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,.75);
            padding: 0.75rem 1rem;
        }
        .sidebar .nav-link:hover {
            color: #fff;
            background: rgba(255,255,255,.1);
        }
        .sidebar .nav-link.active {
            color: #fff;
            background: #0d6efd;
        }
        .sidebar .nav-link i {
            width: 24px;
        }
        .main-content {
            background: #f8f9fa;
            min-height: calc(100vh - 56px);
        }
        .stat-card {
            border: none;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-gear-fill me-2"></i>OpenHost Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/" target="_blank">
                    <i class="bi bi-box-arrow-up-right me-1"></i>View Site
                </a>
                <a class="nav-link" href="/admin/profile">
                    <i class="bi bi-person-circle me-1"></i>Admin
                </a>
                <a class="nav-link" href="/logout">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 sidebar py-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/customers">
                            <i class="bi bi-people me-2"></i>Customers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">
                            <i class="bi bi-cart me-2"></i>Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/services">
                            <i class="bi bi-hdd-stack me-2"></i>Services
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/invoices">
                            <i class="bi bi-receipt me-2"></i>Invoices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/tickets">
                            <i class="bi bi-headset me-2"></i>Tickets
                        </a>
                    </li>
                    <hr class="bg-secondary my-2">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products">
                            <i class="bi bi-box me-2"></i>Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/servers">
                            <i class="bi bi-server me-2"></i>Servers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/domains">
                            <i class="bi bi-globe me-2"></i>Domains
                        </a>
                    </li>
                    <hr class="bg-secondary my-2">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/affiliates">
                            <i class="bi bi-diagram-3 me-2"></i>Affiliates
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/reports">
                            <i class="bi bi-graph-up me-2"></i>Reports
                        </a>
                    </li>
                    <hr class="bg-secondary my-2">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/settings">
                            <i class="bi bi-gear me-2"></i>Settings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/modules">
                            <i class="bi bi-puzzle me-2"></i>Modules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/logs">
                            <i class="bi bi-journal-text me-2"></i>Activity Logs
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 main-content py-4 px-4">
                <h4 class="mb-4">Dashboard Overview</h4>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card bg-primary text-white h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-white-50">Total Revenue</h6>
                                        <h3 id="totalRevenue">$0.00</h3>
                                    </div>
                                    <i class="bi bi-currency-dollar display-5 opacity-50"></i>
                                </div>
                                <small class="text-white-50">This Month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card bg-success text-white h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-white-50">Active Services</h6>
                                        <h3 id="activeServices">0</h3>
                                    </div>
                                    <i class="bi bi-hdd-stack display-5 opacity-50"></i>
                                </div>
                                <small class="text-white-50">Total Active</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card bg-warning text-dark h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-dark-50">Pending Orders</h6>
                                        <h3 id="pendingOrders">0</h3>
                                    </div>
                                    <i class="bi bi-cart display-5 opacity-50"></i>
                                </div>
                                <small class="text-dark-50">Needs Attention</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card bg-danger text-white h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-white-50">Open Tickets</h6>
                                        <h3 id="openTickets">0</h3>
                                    </div>
                                    <i class="bi bi-headset display-5 opacity-50"></i>
                                </div>
                                <small class="text-white-50">Awaiting Response</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Recent Activity -->
                <div class="row">
                    <!-- Quick Actions -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="/admin/customers/new" class="btn btn-outline-primary">
                                        <i class="bi bi-person-plus me-2"></i>Add Customer
                                    </a>
                                    <a href="/admin/orders/new" class="btn btn-outline-primary">
                                        <i class="bi bi-cart-plus me-2"></i>Create Order
                                    </a>
                                    <a href="/admin/invoices/new" class="btn btn-outline-primary">
                                        <i class="bi bi-receipt-cutoff me-2"></i>Create Invoice
                                    </a>
                                    <a href="/admin/announcements/new" class="btn btn-outline-primary">
                                        <i class="bi bi-megaphone me-2"></i>Post Announcement
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="col-md-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Orders</h6>
                                <a href="/admin/orders" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Order #</th>
                                                <th>Customer</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrders">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- More Stats -->
                <div class="row">
                    <!-- Recent Tickets -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-headset me-2"></i>Recent Tickets</h6>
                                <a href="/admin/tickets" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Subject</th>
                                                <th>Priority</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentTickets">
                                            <tr>
                                                <td colspan="3" class="text-center text-muted py-4">
                                                    Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Overdue Invoices -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Overdue Invoices</h6>
                                <a href="/admin/invoices?status=overdue" class="btn btn-sm btn-outline-danger">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Invoice</th>
                                                <th>Customer</th>
                                                <th>Amount</th>
                                                <th>Days</th>
                                            </tr>
                                        </thead>
                                        <tbody id="overdueInvoices">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">
                                                    Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Health -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>System Health</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-database-check display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Database</p>
                                            <span class="badge bg-success">Online</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-envelope-check display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Mail Server</p>
                                            <span class="badge bg-success">Online</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-clock-history display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Cron Jobs</p>
                                            <span class="badge bg-success">Running</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-credit-card display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Payment Gateway</p>
                                            <span class="badge bg-success">Connected</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-server display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Provisioning</p>
                                            <span class="badge bg-success">Online</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center mb-3">
                                        <div class="p-3 rounded bg-success bg-opacity-10">
                                            <i class="bi bi-shield-check display-6 text-success"></i>
                                            <p class="mb-0 mt-2 small">Security</p>
                                            <span class="badge bg-success">Good</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/v1/admin/dashboard');
                const data = await response.json();
                
                if (data.stats) {
                    document.getElementById('totalRevenue').textContent = `$${parseFloat(data.stats.total_revenue || 0).toFixed(2)}`;
                    document.getElementById('activeServices').textContent = data.stats.active_services || 0;
                    document.getElementById('pendingOrders').textContent = data.stats.pending_orders || 0;
                    document.getElementById('openTickets').textContent = data.stats.open_tickets || 0;
                }

                if (data.recent_orders) {
                    displayRecentOrders(data.recent_orders);
                }

                if (data.recent_tickets) {
                    displayRecentTickets(data.recent_tickets);
                }

                if (data.overdue_invoices) {
                    displayOverdueInvoices(data.overdue_invoices);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayRecentOrders(orders) {
            const tbody = document.getElementById('recentOrders');
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No recent orders</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr onclick="window.location='/admin/orders/${order.id}'" style="cursor:pointer">
                    <td>${order.order_number}</td>
                    <td>${order.customer_name || 'N/A'}</td>
                    <td>$${parseFloat(order.total).toFixed(2)}</td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td><small class="text-muted">${new Date(order.created_at).toLocaleDateString()}</small></td>
                </tr>
            `).join('');
        }

        function displayRecentTickets(tickets) {
            const tbody = document.getElementById('recentTickets');
            if (!tickets || tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No recent tickets</td></tr>';
                return;
            }

            tbody.innerHTML = tickets.map(ticket => `
                <tr onclick="window.location='/admin/tickets/${ticket.id}'" style="cursor:pointer">
                    <td>${ticket.subject}</td>
                    <td>${getPriorityBadge(ticket.priority)}</td>
                    <td>${getStatusBadge(ticket.status)}</td>
                </tr>
            `).join('');
        }

        function displayOverdueInvoices(invoices) {
            const tbody = document.getElementById('overdueInvoices');
            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No overdue invoices</td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(invoice => `
                <tr onclick="window.location='/admin/invoices/${invoice.id}'" style="cursor:pointer">
                    <td>${invoice.invoice_number}</td>
                    <td>${invoice.customer_name || 'N/A'}</td>
                    <td class="text-danger">$${parseFloat(invoice.balance).toFixed(2)}</td>
                    <td><span class="badge bg-danger">${invoice.days_overdue} days</span></td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark">Pending</span>',
                'active': '<span class="badge bg-success">Active</span>',
                'completed': '<span class="badge bg-success">Completed</span>',
                'cancelled': '<span class="badge bg-secondary">Cancelled</span>',
                'open': '<span class="badge bg-success">Open</span>',
                'closed': '<span class="badge bg-secondary">Closed</span>',
                'on_hold': '<span class="badge bg-warning text-dark">On Hold</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function getPriorityBadge(priority) {
            const badges = {
                'low': '<span class="badge bg-secondary">Low</span>',
                'normal': '<span class="badge bg-info">Normal</span>',
                'high': '<span class="badge bg-warning text-dark">High</span>',
                'urgent': '<span class="badge bg-danger">Urgent</span>'
            };
            return badges[priority] || badges['normal'];
        }
    </script>
</body>
</html>
