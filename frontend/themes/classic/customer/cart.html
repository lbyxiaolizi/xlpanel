{{define "content"}}
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">{{.T "cart.title"}}</h2>
    </div>

    <!-- Cart Items -->
    <div id="cartContainer">
        <p class="text-center text-gray-500">{{.T "msg.loading"}}</p>
    </div>

    <!-- Cart Summary -->
    <div id="cartSummary" class="hidden mt-8 border-t border-gray-200 pt-6">
        <div class="flex justify-between text-base font-medium text-gray-900 mb-4">
            <p>{{.T "cart.total"}}</p>
            <p id="cartTotal">$0.00</p>
        </div>
        <div class="flex gap-4">
            <button onclick="clearCart()" 
                    class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-300 transition-colors">
                {{.T "cart.clear"}}
            </button>
            <button onclick="checkout()" 
                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">
                {{.T "cart.checkout"}}
            </button>
        </div>
    </div>

    <!-- Empty Cart Message -->
    <div id="emptyCart" class="hidden text-center py-12">
        <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
        <p class="text-xl text-gray-600 mb-4">{{.T "cart.empty"}}</p>
        <a href="/customer/products" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">
            {{.T "products.select"}}
        </a>
    </div>
</div>

<script>
let currentCart = null;
let products = {};

async function loadCart() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        // Load products first
        const productsResponse = await fetch('/catalog/products');
        const productsList = await productsResponse.json();
        productsList.forEach(p => {
            products[p.code] = p;
        });
        
        // Load cart
        const response = await fetch('/api/cart', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        
        if (response.ok) {
            currentCart = await response.json();
            renderCart();
        } else {
            showEmptyCart();
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        showEmptyCart();
    }
}

function renderCart() {
    const container = document.getElementById('cartContainer');
    
    if (!currentCart || !currentCart.items || currentCart.items.length === 0) {
        showEmptyCart();
        return;
    }
    
    document.getElementById('emptyCart').classList.add('hidden');
    document.getElementById('cartSummary').classList.remove('hidden');
    
    let html = '<div class="space-y-4">';
    let total = 0;
    
    currentCart.items.forEach(item => {
        const product = products[item.product_code];
        const itemTotal = item.unit_price * item.quantity;
        total += itemTotal;
        
        html += `
            <div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg">
                <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-box text-blue-600"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900">${product ? product.name : item.product_code}</h4>
                    <p class="text-sm text-gray-500">${item.unit_price} ${currentCart.currency || 'USD'}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="updateQuantity('${item.product_code}', ${item.quantity - 1})" 
                            class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <input type="number" value="${item.quantity}" min="1" 
                           onchange="updateQuantity('${item.product_code}', this.value)"
                           class="w-16 text-center border border-gray-300 rounded px-2 py-1">
                    <button onclick="updateQuantity('${item.product_code}', ${item.quantity + 1})" 
                            class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded hover:bg-gray-100">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-900">${itemTotal.toFixed(2)}</p>
                </div>
                <button onclick="removeItem('${item.product_code}')" 
                        class="text-red-600 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    document.getElementById('cartTotal').textContent = `${total.toFixed(2)} ${currentCart.currency || 'USD'}`;
}

function showEmptyCart() {
    document.getElementById('cartContainer').classList.add('hidden');
    document.getElementById('cartSummary').classList.add('hidden');
    document.getElementById('emptyCart').classList.remove('hidden');
}

async function updateQuantity(productCode, quantity) {
    quantity = parseInt(quantity);
    if (quantity < 0) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/cart/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                product_code: productCode,
                quantity: quantity
            })
        });
        
        if (response.ok) {
            await loadCart();
        }
    } catch (error) {
        console.error('Error updating quantity:', error);
    }
}

async function removeItem(productCode) {
    if (!confirm('{{.T "msg.confirm_delete"}}')) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/cart/remove', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                product_code: productCode
            })
        });
        
        if (response.ok) {
            alert('{{.T "msg.item_removed"}}');
            await loadCart();
        }
    } catch (error) {
        console.error('Error removing item:', error);
    }
}

async function clearCart() {
    if (!confirm('{{if eq .Lang "zh"}}确定要清空购物车吗？{{else}}Are you sure you want to clear the cart?{{end}}')) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/cart/clear', {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        
        if (response.ok) {
            showEmptyCart();
        }
    } catch (error) {
        console.error('Error clearing cart:', error);
    }
}

async function checkout() {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/cart/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('{{if eq .Lang "zh"}}订单创建成功！{{else}}Order created successfully!{{end}}');
            window.location.href = '/customer/orders';
        } else {
            alert('{{.T "msg.error"}}');
        }
    } catch (error) {
        console.error('Error during checkout:', error);
        alert('{{.T "msg.error"}}');
    }
}

// Load cart on page load
loadCart();
</script>
{{end}}
