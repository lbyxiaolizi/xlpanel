{{define "content"}}
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">{{.T "products.title"}}</h2>
        <p class="mt-2 text-sm text-gray-600">
            {{if eq .Lang "zh"}}选择您需要的产品和服务{{else}}Select products and services you need{{end}}
        </p>
    </div>

    <!-- Product Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productGrid">
        <!-- Products will be loaded here -->
    </div>
</div>

<script>
async function loadProducts() {
    try {
        const response = await fetch('/catalog/products');
        const products = await response.json();
        
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';
        
        if (!products || products.length === 0) {
            grid.innerHTML = '<p class="col-span-3 text-center text-gray-500">{{.T "msg.no_data"}}</p>';
            return;
        }
        
        products.forEach(product => {
            const card = createProductCard(product);
            grid.appendChild(card);
        });
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

function createProductCard(product) {
    const div = document.createElement('div');
    div.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow';
    
    const billingType = product.recurring ? '{{.T "products.recurring"}}' : '{{.T "products.one_time"}}';
    
    div.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <div class="p-3 bg-blue-100 rounded-lg">
                <i class="fas fa-box text-2xl text-blue-600"></i>
            </div>
            <span class="text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                ${billingType}
            </span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.name}</h3>
        <p class="text-sm text-gray-600 mb-4">${product.description || ''}</p>
        <div class="flex items-center justify-between">
            <div>
                <span class="text-2xl font-bold text-gray-900">${product.unit_price}</span>
                <span class="text-sm text-gray-500">${product.currency}</span>
                ${product.recurring ? '<span class="text-xs text-gray-500">/ ' + product.billing_days + ' {{if eq .Lang "zh"}}天{{else}}days{{end}}</span>' : ''}
            </div>
        </div>
        <button onclick="addToCart('${product.code}')" 
                class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
            <i class="fas fa-cart-plus mr-2"></i>
            {{.T "products.add_to_cart"}}
        </button>
    `;
    
    return div;
}

async function addToCart(productCode) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                product_code: productCode,
                quantity: 1
            })
        });
        
        if (response.ok) {
            alert('{{.T "msg.item_added"}}');
            // Update cart count in navigation
            updateCartCount();
        } else {
            alert('{{.T "msg.error"}}');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        alert('{{.T "msg.error"}}');
    }
}

async function updateCartCount() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/cart', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        
        if (response.ok) {
            const cart = await response.json();
            const count = cart.items ? cart.items.length : 0;
            // Update count in navigation (would need to add this element to base template)
        }
    } catch (error) {
        console.error('Error updating cart count:', error);
    }
}

// Load products on page load
loadProducts();
</script>
{{end}}
